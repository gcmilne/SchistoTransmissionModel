---
title: "SchistoTransmissionModel: modelling schistosomiasis transmission & immunity"
author: "Gregoy Milne"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SchistoTransmissionModel: modelling schistosomiasis transmission}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Package set-up

The model is implemented in R using the package `Rcpp`. This package can be installed and loaded in R like so:
```{r}
if(!require(Rcpp)) install.packages("Rcpp")
library(Rcpp)
```

The package that runs the model can be installed and loaded like so:
```{r}
if(!require(SchistoTransmissionModel)) install.packages("SchistoTransmissionModel")
library(SchistoTransmissionModel)
```

## Model parameter definition

The function to run the transmission model is `RunTransmissionModel()` (by inspecting the model code found in `schistomod.cpp`, you will see that this is a wrapper function of the `RunModel()` function). The `RunTransmissionModel()` function takes the following arguments:

- `theta`:  a vector of transmission and immunity relevant parameters
- `tx_pars`: a vector of treatment-relevant parameters
- `runtime`: the length of time (in years) to run the model for
- `stepsize`: the integration time step (for instance, 1/12 will give a timestep of 1 month, 1/52 a timestep of 1 week)
- `tx_times`: a vector of times that the model should simulate MDA. This parameter is only used if `tx_pars["input_tx_times"]` is set to 1. Otherwise, if `tx_pars["input_tx_times"]` is set to 0, the model uses the other user-inputted values specified in `tx_pars` to calculate the treatment times. This parameter allows the user to specify MDA times at irregular intervals.


The transmission and immunity model parameters (the `theta` argument of `RunTransmissionModel()`) are defined (with example values) like so:
```{r}
theta <- c(    
  R0                  = 4,
  R0_weight           = 0.5,
  NhNs                = 0.01,
  kW                  = 0.4,
  decay_immunity      = 6,
  protection_immunity = 0,
  epg_constant        = 5.81,
  ige_constant        = 0.1 
)
```

where:

- `R0` is the basic reproduction number
- `R0_weight` controls the relative weighting of R0, from snails-to-human vs. humans-to-snails
- `NhNs` is the human-to-snail population density
- `kW` is the among-host worm overdispersion parameter (inversely related to aggregation)
- `protection_immunity` is the protection afforded by smTAL1-IgE antibodies against cercarial establishment (rage: 0,1)
- `epg_constant` is the no. eggs shed per fertile female schistosome
- `ige_constant` is a constant parameter that maps acquired immunity to antibody optical densities

The treatment relevant parameters (the `tx_pars` argument) are defined (with example values) like so:
```{r}
tx_pars <- c(
  input_tx_times = 0,
  toggle_tx      = 1,
  start_tx       = 20,
  n_tx           = 3,
  freq_tx        = 1,
  coverage       = 0.75,
  efficacy       = 0.95,
  min_tx_age     = 5,
  max_tx_age     = 30,
  cov_weight     = 0.8
)
```

where:

- `input_tx_times`: toggle parameter; when set to 0, treatment times are calculated from input parameters in the `tx_pars` vector; when set to 1 the model uses a user-inputted vector of treatment times
- `toggle_tx`: toggle parameter; when set to 0, the model is simulated without treatment; when set to 1 the model simulates treatment using the other treatment-relevant parameters (below)
- `start_tx`: model time to start treatment (used when `toggle_tx==1`) 
- `n_tx`: number of treatments (integer)
- `freq_tx`: frequency of treatments in years; e.g. freq_tx=1 effects annual MDA, 0.5 twice-annual, 0.25 four-times annual, etc. Note that treatment frequencies must concord with the user-inputted model stepsize (above)
- `coverage`: MDA coverage (a proportion)
- `efficacy`: drug efficacy against adult worms (a proportion from 0 [0% efficacy] to 1 [100% efficacy])
- `min_tx_age`: minimum age of individuals that are treated during MDA (an integer)
- `max_tx_age`: maximum age of individuals that are treated during MDA (an integer)
- `cov_weight`: weighting parameter that distributes coverage (defined by `coverage`) between demographic groups. Specifically, adult coverage = `coverage` * `cov_weight`; SAC coverage = `coverage`; and pre-SAC coverage is 0 (irrespective of inputs; this is hard-coded in the model)

We then set model run time (in years) and model time interval (integration stepsize) by:

```{r}
runtime <- 30     #30 years
stepsize <- 1/12  #1 month
```


## Model simulation

Now that all arguments are defined for `RunTransmissionModel`, the model can be run like so: 

```{r}
sim <- RunTransmissionModel(
  theta    = theta,
  tx_pars  = tx_pars, 
  runtime  = runtime, 
  stepsize = stepsize, 
  tx_times = NA
)
```

Note the use of `tx_times = NA` (since `tx_pars["input_tx_times"]==0`). We'll come back to other parameterisations shortly.


### Visualising model output
The `RunTransmissionModel()` function returns a range of outputs (to explore these, run `View(sim)`). Outputs can be broadly be split into those that are time-dependent and and those that are age- and sex-dependent. We can visualise time-dependent outputs like so (for ease of later demonstrating other examples, we will put the code to plot outputs in a function):

```{r, fig.show='hold'}
plot_time_output <- function(sim){
  plot(sim$time, sim$worm_burden, 'l', xlab = "Time (years)", ylab = "Mean worm burden")
  plot(sim$time, sim$epg, 'l', xlab = "Time (years)", ylab = "Mean epg")
}
plot_time_output(sim)
```

We can visualise age- and sex-dependent outputs at a particular time point of the simulation like so:

```{r, fig.show='hold'}
# Specify time index to extract model output
time_index <- which(sim$time == tx_pars["start_tx"])

# Define a function to plot worm burdens & epgs at particular time index
plot_age_output <- function(sim, time_index) {
  
  # Plot worm burdens
  plot(sim$age, sim$worm_burden_age_female[time_index,], 'l', xlab = "Age (years)", ylab = "Worm burden")
  lines(sim$age, sim$worm_burden_age_male[time_index,], lty=2, col="red")
  
  # Plot epgs
  plot(sim$age, sim$epg_age_female[time_index,], 'l', xlab = "Age (years)", ylab = "epg")
  lines(sim$age, sim$epg_age_male[time_index,], lty=2, col="red")
  
}

# Call function to make plots
plot_age_output(sim, time_index)
```

Note here that the model output (`sim`) is stored in a matrix, such that there is one row per time point. In this example, we therefore specify that we want to extract the age-dependent output at the index corresponding to the time at which MDA begins (`tx_pars["start_tx"]`); although the user can select whatever time point they wish.


### Specification of irregular MDA treatment times

As mentioned earlier, we can specify irregular treatment times via an alternative model parameterisation like so:

```{r}
# set toggle to 1 so model uses 'tx_times', not MDA timing informed by other tx_pars parameters
tx_pars["input_tx_times"] <- 1

# then specify treatment times (just an example)
tx_times <- c(tx_pars["start_tx"], tx_pars["start_tx"]+5, tx_pars["start_tx"]+7)
```

The model can then be simulated with this alternate parameterisation,

```{r}
sim <- RunTransmissionModel(
  theta    = theta,
  tx_pars  = tx_pars, 
  runtime  = runtime, 
  stepsize = stepsize, 
  tx_times = tx_times
)
```

and time-dependent output visualised to demonstrate the effect on MDA timing,

```{r}
plot_time_output(sim)
```
